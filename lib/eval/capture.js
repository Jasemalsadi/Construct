const falafel = require("falafel");
const fs = require("fs");

// Instrument 'eval'
// =================
//
// Attempts to identify any `eval()' calls inside argument `code' and
// instrument the code such that the value passed to `eval()' is sent
// through a function with the name given in argument 1
// (`capfn_ident').
//
// The implementation of `capfn_ident' is not handled here.  It's
// expect that calling code has an implementation for this function
// which it can append to the code generated by `instrument_eval'.
//
function instrument_eval (code, capfn_ident) {

    let instrumented_code = falafel(code, (node) => {

        if (node.type === "CallExpression" && node.callee.name === "eval") {
            if (node.arguments.length > 0) {
                const evalstr = node.arguments[0].source();
                node.arguments[0].update(`${capfn_ident}(${evalstr})`);
            }
        }
    });

    return instrumented_code;
}

module.exports = instrument_eval;
