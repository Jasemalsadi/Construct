const falafel = require("falafel");

// Instrument 'eval'
// =================
//
// Attempts to identify any `eval()' calls inside argument `source' and
// instrument the source such that the value passed to `eval()' is sent
// through a function with the name given in argument 1
// (`capfn_ident').
//
// The implementation of `capfn_ident' is not handled here.  It's
// expect that calling source has an implementation for this function
// which it can append to the source generated by `instrument_eval'.
//
function capture_eval (source, options) {

    options = options || {};
    const defaults = { capture_fn_name: "___EVAL___" };
    options = Object.assign(defaults, options);

    let instrumented_source = falafel(source, function (node) {

        if (node.type === "CallExpression" && node.callee.name === "eval") {
            if (node.arguments.length > 0) {
                const evalstr = node.arguments[0].source();
                node.arguments[0].update(`${options.capture_fn_name}(${evalstr})`);
            }
        }
    });

    return instrumented_source.toString();
}

module.exports = capture_eval;
