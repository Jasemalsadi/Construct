const falafel      = require("falafel"),
      beautify     = require('js-beautify').js_beautify;

// Instrument 'eval'
// =================
//
// Attempts to identify any `eval()' calls inside argument `source' and
// instrument the source such that the value passed to `eval()' is sent
// through a function with the name given in argument 1
// (`capfn_ident').
//
// The implementation of `capfn_ident' is not handled here.  It's
// expect that calling source has an implementation for this function
// which it can append to the source generated by `instrument_eval'.
//
function capture_eval (source, options) {

    options = options || {};
    const defaults = { fn_name: "___EVAL___", beautify: true };
    options = Object.assign(defaults, options);

    let instrumented_source = falafel(source, function (node) {

        if (node.type === "CallExpression" && node.callee.name === "eval") {
            if (node.arguments.length > 0) {
                const evalstr = node.arguments[0].source();
                node.arguments[0].update(`${options.fn_name}(${evalstr})`);
            }
        }
    });

    const capture_fnio = require("./capture_fnio");
    instrumented_source = capture_fnio(instrumented_source.toString(), { fn_name: "capture_fnio" });

    if (options.beautify) {
        return beautify(instrumented_source, { indent_size: 2 });
    }
    else {
        return instrumented_source.toString();
    }
}

module.exports = capture_eval;
